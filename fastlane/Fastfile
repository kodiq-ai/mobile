default_platform(:ios)

platform :ios do
  desc "Build and upload to TestFlight"
  lane :beta do
    # Code signing via Fastlane Match (git-based cert storage)
    match(
      type: "appstore",
      readonly: is_ci,
      git_url: ENV["MATCH_GIT_URL"],
    )

    # Increment build number (CI-friendly: use run number)
    increment_build_number(
      build_number: ENV["GITHUB_RUN_NUMBER"] || "1",
      xcodeproj: "ios/KodiqAcademy.xcodeproj",
    )

    # Build
    build_app(
      workspace: "ios/KodiqAcademy.xcworkspace",
      scheme: "KodiqAcademy",
      export_method: "app-store",
      output_directory: "ios/build",
      clean: true,
    )

    # Upload to TestFlight
    if is_ci
      api_key = app_store_connect_api_key(
        key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
        issuer_id: ENV["APP_STORE_CONNECT_API_ISSUER_ID"],
        key_content: ENV["APP_STORE_CONNECT_API_KEY"],
        is_key_content_base64: true,
      )

      upload_to_testflight(
        api_key: api_key,
        skip_waiting_for_build_processing: true,
      )
    end
  end
end
