default_platform(:ios)

platform :ios do
  # --- Helpers ---

  desc "Create App Store Connect API key from env"
  lane :api_key do
    app_store_connect_api_key(
      key_id: ENV["APPSTORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["APPSTORE_CONNECT_ISSUER_ID"],
      key_content: ENV["APPSTORE_CONNECT_API_KEY_CONTENT"],
      is_key_content_base64: true,
    )
  end

  # --- Certificate management ---

  desc "Sync certificates and provisioning profiles"
  lane :certificates do
    api_key
    match(type: "development", readonly: false)
    match(type: "appstore", readonly: false)
  end

  desc "Register new device and refresh profiles"
  lane :add_device do |options|
    register_devices(devices: { options[:name] => options[:udid] })
    match(type: "development", force_for_new_devices: true)
  end

  # --- Build ---

  desc "Build and upload to TestFlight"
  lane :beta do
    setup_ci if is_ci

    api_key

    match(type: "appstore", readonly: false)

    cocoapods(
      podfile: "./ios/Podfile",
      repo_update: true,
    )

    if ENV["BUILD_VERSION"]
      increment_version_number(
        version_number: ENV["BUILD_VERSION"],
        xcodeproj: "./ios/KodiqAcademy.xcodeproj",
      )
    end

    increment_build_number(
      build_number: Time.now.strftime("%Y%m%d%H%M"),
      xcodeproj: "./ios/KodiqAcademy.xcodeproj",
    )

    build_app(
      workspace: "./ios/KodiqAcademy.xcworkspace",
      scheme: "KodiqAcademy",
      configuration: "Release",
      export_method: "app-store",
      codesigning_identity: "Apple Distribution",
      export_options: {
        provisioningProfiles: {
          "ai.kodiq" => "match AppStore ai.kodiq",
        },
      },
    )

    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      distribute_external: false,
      groups: ["Internal Testers"],
      changelog: ENV["BUILD_CHANGELOG"] || "New build",
    )
  end

  # --- Release ---

  desc "Build and upload to App Store (production)"
  lane :release do
    setup_ci if is_ci

    api_key

    match(type: "appstore", readonly: false)

    cocoapods(
      podfile: "./ios/Podfile",
      repo_update: true,
    )

    build_app(
      workspace: "./ios/KodiqAcademy.xcworkspace",
      scheme: "KodiqAcademy",
      configuration: "Release",
      export_method: "app-store",
    )

    upload_to_app_store(
      skip_screenshots: true,
      skip_metadata: false,
      force: true,
    )
  end
end
