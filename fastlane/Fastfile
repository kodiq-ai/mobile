default_platform(:ios)

platform :ios do
  # --- Helpers ---

  desc "Create App Store Connect API key from env"
  lane :api_key do
    app_store_connect_api_key(
      key_id: ENV["APPSTORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["APPSTORE_CONNECT_ISSUER_ID"],
      key_content: ENV["APPSTORE_CONNECT_API_KEY_CONTENT"],
      is_key_content_base64: true,
    )
  end

  # --- Certificate management ---

  desc "Sync certificates and provisioning profiles"
  lane :certificates do
    api_key
    match(type: "development", readonly: false)
    match(type: "appstore", readonly: false)
  end

  desc "Register new device and refresh profiles"
  lane :add_device do |options|
    register_devices(devices: { options[:name] => options[:udid] })
    match(type: "development", force_for_new_devices: true)
  end

  # --- TestFlight setup ---

  desc "Configure TestFlight beta app info and enable auto-distribution"
  lane :setup_testflight do
    api_key

    # Set beta app localization (required by Apple for distribution)
    require "spaceship"
    token = Spaceship::ConnectAPI::Token.from(hash: lane_context[SharedValues::APP_STORE_CONNECT_API_KEY])
    Spaceship::ConnectAPI.token = token

    app = Spaceship::ConnectAPI::App.find("ai.kodiq")
    UI.user_error!("App ai.kodiq not found") unless app

    # Check beta app localizations
    localizations = app.get_beta_app_localizations
    if localizations.empty?
      Spaceship::ConnectAPI.post_beta_app_localizations(
        app_id: app.id,
        attributes: {
          locale: "ru",
          description: "Kodiq Academy — образовательная платформа для обучения программированию и IT-навыкам.",
          feedbackEmail: "app@kodiq.ai",
        },
      )
      UI.success("Created beta app localization (ru)")
    else
      UI.success("Beta app localization already exists (#{localizations.first.locale})")
    end

    # List all beta groups
    groups = app.get_beta_groups
    UI.success("Found #{groups.count} beta group(s):")
    groups.each do |g|
      UI.message("  - '#{g.name}' (internal: #{g.is_internal_group})")
    end
  end

  # --- Build ---

  desc "Build and upload to TestFlight"
  lane :beta do
    setup_ci if is_ci

    api_key

    match(type: "appstore", readonly: false)

    cocoapods(
      podfile: "./ios/Podfile",
      repo_update: true,
    )

    if ENV["BUILD_VERSION"]
      increment_version_number(
        version_number: ENV["BUILD_VERSION"],
        xcodeproj: "./ios/KodiqAcademy.xcodeproj",
      )
    end

    increment_build_number(
      build_number: Time.now.strftime("%Y%m%d%H%M"),
      xcodeproj: "./ios/KodiqAcademy.xcodeproj",
    )

    update_code_signing_settings(
      use_automatic_signing: false,
      path: "./ios/KodiqAcademy.xcodeproj",
      team_id: ENV["APPLE_TEAM_ID"] || "JRJGS4U2DJ",
      bundle_identifier: "ai.kodiq",
      code_sign_identity: "Apple Distribution",
      profile_name: "match AppStore ai.kodiq",
    )

    build_app(
      workspace: "./ios/KodiqAcademy.xcworkspace",
      scheme: "KodiqAcademy",
      configuration: "Release",
      export_method: "app-store",
      codesigning_identity: "Apple Distribution",
      export_options: {
        provisioningProfiles: {
          "ai.kodiq" => "match AppStore ai.kodiq",
        },
      },
    )

    upload_to_testflight(
      skip_waiting_for_build_processing: false,
      distribute_external: false,
      groups: ["kodiq"],
      changelog: ENV["BUILD_CHANGELOG"] || "New build",
    )
  end

  # --- Release ---

  desc "Build and upload to App Store (production)"
  lane :release do
    setup_ci if is_ci

    api_key

    match(type: "appstore", readonly: false)

    cocoapods(
      podfile: "./ios/Podfile",
      repo_update: true,
    )

    build_app(
      workspace: "./ios/KodiqAcademy.xcworkspace",
      scheme: "KodiqAcademy",
      configuration: "Release",
      export_method: "app-store",
    )

    upload_to_app_store(
      skip_screenshots: true,
      skip_metadata: false,
      force: true,
    )
  end
end
